# Introduction

RNA velocity is a method to infer the direction and speed of gene expression changes in single cells. The method is based on the idea that the ratio of unspliced to spliced mRNA can be used to infer the rate of change of gene expression. The method was first described in [La Manno et al. (2018)](https://doi.org/10.1038/s41586-018-0414-6) and implemented in the [velocyto](http://velocyto.org/) package. The method has been implemented in other packages, including [scVelo](https://scvelo.readthedocs.io/) that improves on the original method by using a dynamical model to infer the RNA velocity.

The scripts in this folder perform RNA velocity analysis using the velocyto package and scVelo. We assume that user already have a clustered dataset and would like to perform RNA velocity analysis respecting previously defined clusters, and their UMAP coordinates (to allow comparable plots between analysis). **This requirement makes the analyse more complicated, and more care is needed by the user to ensure that the all is performed correctly**. The scripts expect a Seurat object, including clusters and dimensionality reduction, as input.

Alternatively, it is also possible to load the velocity data and perform all steps of normalization and clustering using the counts of the spliced dataset. This approach is not cover here.

As inplemented here, there are three scripts that should be run in the following order:

## 1. Generating spliced and unspliced matrices using Velocyto

NOTE: This analysis require a large amount of memory and can be speed up by running in parallel. Therefore, the scripts are written to be run on a cluster using the SLURM scheduler (such as the one used in the HiperGator).

The first step of the analysis is to generate the spliced and unspliced matrices using the velocyto package. 

As implemented in the script below, the velocyto package requires the output files generated by the cellranger pipeline. The velocyto package also requires the gtf file used by cellranger to generate the bam files. The GTF file should have the exon information for the genes.

**Before executing the script showed below, change the header of the sbatch file and the names of the output folder and GTF file.**

For each sample, execute the script `velocyto.sbatch`.

```{bash}
sbatch velocyto.sbatch
```

The velocyto script will generate a loom file within the cell ranger folder used as input. The loom file will be named `velocyto_output.loom`.

### 1.1. Combining loom files

If the goal of the analysis is to use multiple integrated samples for the velocity, the loom files generated by velocyto should be combined into a single loom file. In this folder we have a python script that perfoms this task. The script is called `combining_loom_files_with_loompy.py` and can be executed as follows:

Remember to change the path of the input files in the script. Optionally, you can run this script within a sbatch file.

| :warning: WARNING          |
|:---------------------------|
| The loom files of the individual samples used as input in the script bellow must be in the same order as the samples were used during the integration on Seurat.|

The order of the samples is important because Seurat rename the barcodes of the integrated dataset based on the order of the samples used for integration. The loom files generated by velocyto are named based on the barcodes of the bam files. The script in the next step (1.2) will use this order to rename the barcodes, allowing matching them between the Seurat object and the velocyto output.

The package loompy (https://loompy.org/) should be installed in the environment used to run this script.

```{bash}
python3 combining_loom_files_with_loompy.py
```

## 2. Preparing data for scVelo. 

The next step of the analysis is to merge the Seurat clustered dataset to the velocyto output. In this way, the UMAP coordinates and the cluster information can be kept for the scVelo outputs.


```{r}
Rscript preparing_data_for_scVelo.R
```

